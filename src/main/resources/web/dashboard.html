<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Monitor - –ü–∞–Ω–µ–ª—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 0.9em;
            text-transform: uppercase;
            margin-bottom: 10px;
            letter-spacing: 1px;
        }

        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #333;
        }

        .stat-card .label {
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .chart-container h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .chart-wrapper {
            position: relative;
            height: 300px;
        }

        .players-list {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .players-list h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .player-item {
            padding: 12px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item:last-child {
            border-bottom: none;
        }

        .player-name {
            font-weight: 600;
            color: #333;
        }

        .player-stats {
            color: #666;
            font-size: 0.9em;
        }

        .online-badge {
            background: #4ade80;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin: 20px auto;
            display: block;
            transition: background 0.3s ease;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #667eea;
        }

        .modal-header h2 {
            color: #667eea;
            margin: 0;
            font-size: 1.8em;
        }

        .close {
            color: #aaa;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close:hover {
            color: #667eea;
        }

        .player-detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .detail-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .detail-card h3 {
            margin: 0 0 10px 0;
            font-size: 0.9em;
            text-transform: uppercase;
            opacity: 0.9;
        }

        .detail-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .detail-card .label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-top: 5px;
        }

        .player-name-clickable {
            cursor: pointer;
            transition: color 0.3s, transform 0.2s;
        }

        .player-name-clickable:hover {
            color: #667eea;
            transform: translateX(5px);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Online Monitor</h1>
            <p>Minecraft server statistic panel</p>
        </header>

        <div id="loading" class="loading">Data loading...</div>

        <div id="content" style="display: none;">
            <div class="stats-grid" id="statsGrid"></div>

            <div class="chart-container">
                <h2>üìà Hourly statistic online (7 days)</h2>
                <div class="chart-wrapper">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <h2>üìÖ Daily average online (30 day)</h2>
                <div class="chart-wrapper">
                    <canvas id="dailyChart"></canvas>
                </div>
            </div>

            <div class="players-list" id="playersList">
                <h2>üéÆ Top players by connections</h2>
                <div id="topPlayers"></div>
            </div>

            <button class="refresh-btn" onclick="loadAllData()">üîÑ Refresh</button>
        </div>
    </div>

    <div id="playerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalPlayerName">Player data</h2>
                <span class="close" onclick="closePlayerModal()">&times;</span>
            </div>
            <div id="playerDetails" class="player-detail-grid">
            </div>
        </div>
    </div>

    <script>
        let hourlyChart, dailyChart;

        async function loadStats() {
            try {
                const response = await fetch('/api/stats');
                const data = await response.json();

                const statsGrid = document.getElementById('statsGrid');
                statsGrid.innerHTML = `
                    <div class="stat-card">
                        <h3>Online record</h3>
                        <div class="value">${data.maxOnline}</div>
                        <div class="label">–∏–≥—Ä–æ–∫–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <h3>Uniq players</h3>
                        <div class="value">${data.uniquePlayers}</div>
                        <div class="label">–≤—Å–µ–≥–æ</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total sessions</h3>
                        <div class="value">${data.totalSessions}</div>
                        <div class="label">–∑–∞—Ö–æ–¥–æ–≤</div>
                    </div>
                    <div class="stat-card">
                        <h3>Active sessions</h3>
                        <div class="value">${data.activeSessions}</div>
                        <div class="label">—Å–µ–π—á–∞—Å</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total play time</h3>
                        <div class="value">${formatPlaytime(data.totalPlaytime)}</div>
                        <div class="label">—á–∞—Å–æ–≤</div>
                    </div>
                `;

                const topPlayers = document.getElementById('topPlayers');
                topPlayers.innerHTML = '';
                let rank = 1;
                for (const [name, joins] of Object.entries(data.topPlayers)) {
                    const div = document.createElement('div');
                    div.className = 'player-item';
                    div.innerHTML = `
                        <span class="player-name player-name-clickable" onclick="showPlayerStats('${name}')">${rank}. ${name}</span>
                        <span class="player-stats">${joins} –∑–∞—Ö–æ–¥–æ–≤</span>
                    `;
                    topPlayers.appendChild(div);
                    rank++;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadOnline() {
            try {
                const response = await fetch('/api/online');
                const data = await response.json();
                console.log('Current online:', data);
            } catch (error) {
                console.error('Error loading online:', error);
            }
        }

        async function loadHourlyChart() {
            try {
                const response = await fetch('/api/snapshots?type=hourly&days=7');
                const data = await response.json();

                const labels = Object.keys(data).map(h => h + ':00');
                const values = Object.values(data);

                const ctx = document.getElementById('hourlyChart').getContext('2d');
                if (hourlyChart) hourlyChart.destroy();

                hourlyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Avarage online',
                            data: values,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading hourly chart:', error);
            }
        }

        async function loadDailyChart() {
            try {
                const response = await fetch('/api/snapshots?type=daily&days=30');
                const data = await response.json();

                const labels = Object.keys(data);
                const values = Object.values(data);

                const ctx = document.getElementById('dailyChart').getContext('2d');
                if (dailyChart) dailyChart.destroy();

                dailyChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Average online',
                            data: values,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: '#667eea',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading daily chart:', error);
            }
        }

        function formatPlaytime(milliseconds) {
            const hours = Math.floor(milliseconds / (1000 * 60 * 60));
            return hours.toLocaleString();
        }

        async function loadAllData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('content').style.display = 'none';

            await Promise.all([
                loadStats(),
                loadOnline(),
                loadHourlyChart(),
                loadDailyChart()
            ]);

            document.getElementById('loading').style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏–≥—Ä–æ–∫–∞
        async function showPlayerStats(playerName) {
            try {
                const response = await fetch(`/api/players?name=${encodeURIComponent(playerName)}`);
                const data = await response.json();

                document.getElementById('modalPlayerName').textContent = `üéÆ ${playerName}`;

                const hoursPlayed = Math.floor(data.totalPlaytime / (1000 * 60 * 60));
                const minutesPlayed = Math.floor((data.totalPlaytime % (1000 * 60 * 60)) / (1000 * 60));

                const playerDetails = document.getElementById('playerDetails');
                playerDetails.innerHTML = `
                    <div class="detail-card">
                        <h3>Total connections</h3>
                        <div class="value">${data.joinCount}</div>
                        <div class="label">times</div>
                    </div>
                    <div class="detail-card">
                        <h3>Time played</h3>
                        <div class="value">${hoursPlayed}</div>
                        <div class="label">${hoursPlayed} h ${minutesPlayed} min</div>
                    </div>
                    <div class="detail-card">
                        <h3>‚ò†Ô∏è Deaths</h3>
                        <div class="value">${data.deaths || 0}</div>
                        <div class="label">times</div>
                    </div>
                    <div class="detail-card">
                        <h3>‚öîÔ∏è Mob Kills</h3>
                        <div class="value">${data.mobKills || 0}</div>
                        <div class="label">mobs</div>
                    </div>
                    <div class="detail-card">
                        <h3>üó°Ô∏è PvP Kills</h3>
                        <div class="value">${data.playerKills || 0}</div>
                        <div class="label">players</div>
                    </div>
                    <div class="detail-card">
                        <h3>‚õèÔ∏è Blocks Broken</h3>
                        <div class="value">${data.blocksBroken || 0}</div>
                        <div class="label">blocks</div>
                    </div>
                    <div class="detail-card">
                        <h3>üß± Blocks Placed</h3>
                        <div class="value">${data.blocksPlaced || 0}</div>
                        <div class="label">blocks</div>
                    </div>
                    <div class="detail-card">
                        <h3>üí¨ Messages Sent</h3>
                        <div class="value">${data.messagesSent || 0}</div>
                        <div class="label">messages</div>
                    </div>
                `;

                document.getElementById('playerModal').style.display = 'block';
            } catch (error) {
                console.error('Error loading player stats:', error);
                alert('Fail to load player statistic');
            }
        }

        function closePlayerModal() {
            document.getElementById('playerModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('playerModal');
            if (event.target === modal) {
                closePlayerModal();
            }
        }

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closePlayerModal();
            }
        });

        loadAllData();
        setInterval(loadAllData, 30000);
    </script>
</body>
</html>